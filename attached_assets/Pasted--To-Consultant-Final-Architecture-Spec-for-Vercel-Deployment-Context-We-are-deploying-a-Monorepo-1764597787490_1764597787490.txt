ğŸ“‹ To Consultant: Final Architecture Spec for Vercel Deployment
Context: We are deploying a Monorepo (Express Backend + Vite Frontend) to Vercel. The database has been migrated to Supabase (PostgreSQL). We need to refactor the codebase to ensure Vercel can correctly serve the static frontend and route API requests to the Express app via Serverless Functions.

Please review and execute the following 5-Point Refactoring Plan:

1. Project Structure & Routing (vercel.json)
Create/Update vercel.json in the root to handle traffic distribution.

Logic:

/api/* -> Handled by the Serverless Function (api/index.ts).

/* -> Handled by the Static Frontend (dist/public/index.html as SPA fallback).

JSON

{
  "version": 2,
  "rewrites": [
    { "source": "/api/(.*)", "destination": "/api/index" },
    { "source": "/(.*)", "destination": "/dist/public/index.html" }
  ]
}
2. The Serverless Bridge (api/index.ts)
Create a new file api/index.ts. This acts as the entry point for Vercel.

Action:

Modify server/index.ts (or server/app.ts) to export the app instance (e.g., export default app) instead of just calling app.listen().

In api/index.ts, import that app and export it for Vercel.

3. Database Connection Refactor (server/db.ts)
We are using Supabase Transaction Pooler (Port 6543).

Action:

Remove @neondatabase/serverless dependencies.

Install pg and @types/pg.

Configure the Pool to use process.env.DATABASE_URL.

TypeScript

import { drizzle } from "drizzle-orm/node-postgres";
import { Pool } from "pg";
import * as schema from "@shared/schema";

if (!process.env.DATABASE_URL) {
  throw new Error("DATABASE_URL must be set.");
}

export const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  max: 20, // Prevent exhausting Supabase pool
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
});

export const db = drizzle(pool, { schema });
4. Build Strategy (package.json)
We need a unified build command that Vercel can execute.

Output Goal:

Frontend -> dist/public

Backend -> Compiled TS available for api/index.ts to import.

Scripts Update:

"build:client": vite build --outDir dist/public --emptyOutDir

"build": npm run build:client (Vercel will handle the backend TS via its internal build step if api folder exists).

5. Environment Variables Check
Ensure the application logic relies on these standard vars:

DATABASE_URL (Supabase Pooler Connection)

NEXTAUTH_URL (Production URL)

NEXTAUTH_SECRET

GOOGLE_CLIENT_ID / SECRET

GEMINI_API_KEY

â“ Confirmation Question:
Does this refactoring plan correctly address the "Express on Vercel" limitation? Is there any specific configuration for drizzle-orm needed when switching from Neon to standard Postgres?

PM (G å°ˆæ¡ˆ) çš„æœ€å¾Œå®åš€
é€™ä»½æ–‡ä»¶ç™¼å‡ºå»å¾Œï¼Œå¦‚æœé¡§å•å›è¦† "Looks good" æˆ–é–‹å§‹åŸ·è¡Œä»£ç¢¼ä¿®æ”¹ï¼Œé‚£å°±ä»£è¡¨æˆ‘å€‘ç©©äº†ã€‚

åŸ·è¡Œå®Œå¾Œï¼Œè¨˜å¾—ï¼š

git push åˆ° GitHubã€‚

å» Vercel ç¢ºä¿ Framework Preset é¸ "Other"ï¼ŒOutput Directory è¨­ç‚º dist/public (æ ¹æ“šä¸Šé¢è¨ˆç•«)ã€‚

Redeployã€‚